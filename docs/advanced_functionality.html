
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>4. Advanced functionality &#8212; Reflectorch Documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'advanced_functionality';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5. API Reference" href="api.html" />
    <link rel="prev" title="3. Training a reflectorch model" href="training_reflectorch.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/reflectorch_logo.png" class="logo__image only-light" alt="Reflectorch Documentation - Home"/>
    <script>document.write(`<img src="_static/reflectorch_logo.png" class="logo__image only-dark" alt="Reflectorch Documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Reflectorch
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="installation.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_reflectorch.html">2. Using a trained reflectorch model</a></li>
<li class="toctree-l1"><a class="reference internal" href="training_reflectorch.html">3. Training a reflectorch model</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">4. Advanced functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">5. API Reference</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>



<a href="https://github.com/schreiber-lab/reflectorch" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/advanced_functionality.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Advanced functionality</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-alternative-parameterizations-of-the-sld-profile">4.1. Using alternative parameterizations of the SLD profile</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-with-absorption">4.1.1. Model with absorption</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#periodically-repeating-monolayer">4.1.2. Periodically repeating monolayer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#trainer">4.1.2.1. Trainer</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inference">4.1.2.2. Inference</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-with-shifts">4.1.3. Model with shifts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-alternative-embedding-networks">4.2. Using alternative embedding networks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-alternative-trainers">4.3. Using alternative trainers</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="advanced-functionality">
<h1><span class="section-number">4. </span>Advanced functionality<a class="headerlink" href="#advanced-functionality" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span>

<span class="kn">from</span> <span class="nn">reflectorch</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">reflectorch.extensions.jupyter</span> <span class="kn">import</span> <span class="n">JPlotLoss</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1"># set seed for reproducibility</span>
</pre></div>
</div>
</div>
</div>
<section id="using-alternative-parameterizations-of-the-sld-profile">
<h2><span class="section-number">4.1. </span>Using alternative parameterizations of the SLD profile<a class="headerlink" href="#using-alternative-parameterizations-of-the-sld-profile" title="Link to this heading">#</a></h2>
<p>In this section we describe alternative parameterizations of the SLD profile implementated in <code class="docutils literal notranslate"><span class="pre">reflectorch</span></code> (i.e. other than the standard box model parameterization)</p>
<section id="model-with-absorption">
<h3><span class="section-number">4.1.1. </span>Model with absorption<a class="headerlink" href="#model-with-absorption" title="Link to this heading">#</a></h3>
<p>The default box model parameterization of the SLD profile presented in the previous sections takes into account only the real part of the SLD profile but neglects the imaginary part of the SLD which is related to the absorption of the scattering medium. While this is a reasonable approximation in many use cases, in <code class="docutils literal notranslate"><span class="pre">reflectorch</span></code> we are able to alter the parameterization of the SLD profile as to also incorporate the constant imaginary SLD value of each layer.</p>
<p>We can initialize a reflectorch model with absorption by making the following changes to the YAML configuration file:</p>
<ol class="arabic simple">
<li><p>Firstly, we set the <code class="docutils literal notranslate"><span class="pre">model_name</span></code> argument of the prior sampler to <code class="docutils literal notranslate"><span class="pre">model_with_absorption</span></code> instead of <code class="docutils literal notranslate"><span class="pre">standard_model</span></code>. In addition, the parameter range and bound width range of the imaginary layer SLDs (<code class="docutils literal notranslate"><span class="pre">islds</span></code>) must be specified. If <code class="docutils literal notranslate"><span class="pre">constrained_isld</span></code> is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, the imaginary part of the SLD is constrained to not exceed a predefined fraction <code class="docutils literal notranslate"><span class="pre">max_sld_share</span></code> of the real part of the SLD (<strong>Note</strong>: <code class="docutils literal notranslate"><span class="pre">constrained_roughness</span></code> must also be <code class="docutils literal notranslate"><span class="pre">true</span></code>).</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dset</span><span class="p">:</span>
<span class="w">  </span><span class="nt">prior_sampler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SubpriorParametricSampler</span>
<span class="w">    </span><span class="nt">kwargs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">param_ranges</span><span class="p">:</span>
<span class="w">        </span><span class="nt">thicknesses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">300.</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">roughnesses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20.</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">slds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">50.</span><span class="p p-Indicator">]</span>
<span class="hll"><span class="w">        </span><span class="nt">islds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.</span><span class="p p-Indicator">]</span>
</span><span class="w">      </span><span class="nt">bound_width_ranges</span><span class="p">:</span>
<span class="w">        </span><span class="nt">thicknesses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">1.0e-2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">300.</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">roughnesses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">1.0e-2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20.</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">slds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">1.0e-2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10.</span><span class="p p-Indicator">]</span>
<span class="hll"><span class="w">        </span><span class="nt">islds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">1.0e-2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.</span><span class="p p-Indicator">]</span>
</span><span class="hll"><span class="w">      </span><span class="nt">model_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_with_absorption</span>
</span><span class="w">      </span><span class="nt">max_num_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">      </span><span class="nt">constrained_roughness</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="hll"><span class="w">      </span><span class="nt">constrained_isld</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span class="w">      </span><span class="nt">max_thickness_share</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
<span class="hll"><span class="w">      </span><span class="nt">max_sld_share</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span>
</span><span class="w">      </span><span class="nt">logdist</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">scale_params_by_ranges</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">scaled_range</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-1.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cuda&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>For the 2-layer box model parameterization of the SLD profile without absorption, the neural network had to predict 8 values (2 thicknesses, 3 roughnesses, 3 real layer SLDs). When absorption is considered, we have 3 additional output values (the imaginary layer SLDs), summing up to a total of 11. The computation for a higher number of layers is analogous. Thus the neural network architecture must also reflect these changes in the input and output dimensionalities: in this example the <code class="docutils literal notranslate"><span class="pre">dim_out</span></code> argument is set to 11.</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">network</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkWithPriorsConvEmb</span>
<span class="w">    </span><span class="nt">pretrained_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">    </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cuda&#39;</span>
<span class="w">    </span><span class="nt">kwargs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">in_channels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">hidden_channels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">32</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">64</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">128</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">256</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">512</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">dim_embedding</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<span class="w">      </span><span class="nt">dim_avpool</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">embedding_net_activation</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;gelu&#39;</span>
<span class="w">      </span><span class="nt">use_batch_norm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="hll"><span class="w">      </span><span class="nt">dim_out</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">11</span>
</span><span class="w">      </span><span class="nt">layer_width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="w">      </span><span class="nt">num_blocks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span>
<span class="w">      </span><span class="nt">repeats_per_block</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">      </span><span class="nt">mlp_activation</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;gelu&#39;</span>
<span class="w">      </span><span class="nt">dropout_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span><span class="w"> </span>
<span class="w">      </span><span class="nt">pretrained_embedding_net</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</pre></div>
</div>
<p>We initialize a model with absorption from a suitable configuration file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">get_trainer_by_name</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="s1">&#39;c_absorption&#39;</span><span class="p">,</span> <span class="n">load_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model c_absorption loaded. Number of parameters: 3.84 M
</pre></div>
</div>
</div>
</div>
<p>We observe that the parametric model is <code class="docutils literal notranslate"><span class="pre">ModelWithAbsorption</span></code> and the sampler strategy is <code class="docutils literal notranslate"><span class="pre">ConstrainedRoughnessAndImgSldSamplerStrategy</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">prior_sampler</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">trainer</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">prior_sampler</span><span class="o">.</span><span class="n">param_model</span><span class="p">,</span> <span class="n">trainer</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">prior_sampler</span><span class="o">.</span><span class="n">param_model</span><span class="o">.</span><span class="n">sampler_strategy</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;model_with_absorption&#39;,
 &lt;reflectorch.data_generation.priors.parametric_models.ModelWithAbsorption at 0x1b1e0fd2100&gt;,
 &lt;reflectorch.data_generation.priors.sampler_strategies.ConstrainedRoughnessAndImgSldSamplerStrategy at 0x1b1e0fd21f0&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">simulated_data</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>

<span class="n">n_layers</span> <span class="o">=</span> <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max_layer_num</span>
<span class="n">n_params</span> <span class="o">=</span> <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_params</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of layers: </span><span class="si">{</span><span class="n">n_layers</span><span class="si">}</span><span class="s1">,  Number of film parameters: </span><span class="si">{</span><span class="n">n_params</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SLD data type: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slds</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Img slds properly constrained with respect to real slds: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_is_all_true</span><span class="p">(</span><span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slds</span><span class="o">.</span><span class="n">imag</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slds</span><span class="o">.</span><span class="n">real</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of layers: 2,  Number of film parameters: 11
SLD data type: torch.complex128
Img slds properly constrained with respect to real slds: True
</pre></div>
</div>
</div>
</div>
<p>We observe that the <code class="docutils literal notranslate"><span class="pre">slds</span></code> tensor is of complex type now. The absorption leads to the rounding of the total reflection edge and the smoothing-off of oscillations of the reflectivity curve.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">to_np</span><span class="p">(</span><span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;q_values&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">scaled_noisy_curves</span> <span class="o">=</span> <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;scaled_noisy_curves&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;q [$Å^{-1}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R$_</span><span class="si">{scaled}</span><span class="s1">$ (q)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">to_np</span><span class="p">(</span><span class="n">scaled_noisy_curves</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">2.0</span><span class="p">);</span>

<span class="n">z_axis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">sld_profile_real</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_density_profiles</span><span class="p">(</span>
    <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">thicknesses</span><span class="p">,</span> 
    <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">roughnesses</span><span class="p">,</span>
    <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slds</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
    <span class="n">z_axis</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">sld_profile_imag</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_density_profiles</span><span class="p">(</span>
    <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">thicknesses</span><span class="p">,</span> 
    <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">roughnesses</span><span class="p">,</span>
    <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slds</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
    <span class="n">z_axis</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">to_np</span><span class="p">(</span><span class="n">z_axis</span><span class="p">),</span> <span class="n">to_np</span><span class="p">(</span><span class="n">sld_profile_real</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Re(SLD)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">to_np</span><span class="p">(</span><span class="n">z_axis</span><span class="p">),</span> <span class="n">to_np</span><span class="p">(</span><span class="n">sld_profile_imag</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;violet&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Im(SLD)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;z [$Å$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;SLD [$10^{-6} Å^{-2}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/4d27eb91adf7ec25746b09811fb942ba4f3cbf658a3863b2c2187d81b8cbcf01.png" src="_images/4d27eb91adf7ec25746b09811fb942ba4f3cbf658a3863b2c2187d81b8cbcf01.png" />
</div>
</div>
</section>
<section id="periodically-repeating-monolayer">
<h3><span class="section-number">4.1.2. </span>Periodically repeating monolayer<a class="headerlink" href="#periodically-repeating-monolayer" title="Link to this heading">#</a></h3>
<p>This SLD parameterization addresses the following commonly encountered scenario for thin films. On top of a silicon/silicon oxide substrate we consider a thin film composed of repeating identical monolayers (grey curve in the figure), each monolayer consisting of two boxes with distinct SLDs. A sigmoid envelope modulating the SLD profile of the monolayers defines the film thickness and the roughness at the top interface (green curve in the figure). A second sigmoid envelope can be used to modulate the amplitude of the monolayer SLDs as a function of the displacement from the position
of the first sigmoid (red curve in the figure). These two sigmoids allow one to model a thin film that is coherently ordered up to a certain coherent thickness and gets incoherently ordered or amorphous toward the top of the film. In addition, a layer between the substrate and the multilayer (i.e. ”phase layer”) is introduced to account for the interface structure, which does not necessarily have to be identical to the multilayer period.</p>
<figure class="align-center" id="figure-multilayer">
<a class="reference internal image-reference" href="_images/sketch_multilayer_0.png"><img alt="_images/sketch_multilayer_0.png" src="_images/sketch_multilayer_0.png" style="width: 763.0px; height: 503.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 4.1 </span><span class="caption-text">SLD parameterization of a multilayer consisting of periodically repeating monolayers</span><a class="headerlink" href="#figure-multilayer" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>This parameterization is described by 17 film parameters, their physical description together with their corresponding alias in the YAML configuration file being shown in the following table:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parameter description</strong></p></th>
<th class="head"><p><strong>Parameter alias in the configuration file</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>monolayer thickness (i.e. two boxes stacked together)</p></td>
<td><p>d_block</p></td>
</tr>
<tr class="row-odd"><td><p>relative roughness of the monolayer interfaces (wrt. the monolayer thickness)</p></td>
<td><p>s_block_rel</p></td>
</tr>
<tr class="row-even"><td><p>SLD of the first box in the monolayer</p></td>
<td><p>r_block</p></td>
</tr>
<tr class="row-odd"><td><p>SLD difference between the second and the first box in the monolayer</p></td>
<td><p>dr</p></td>
</tr>
<tr class="row-even"><td><p>fraction of the monolayer thickness belonging to the first box</p></td>
<td><p>d_block1_rel</p></td>
</tr>
<tr class="row-odd"><td><p>roughness of the silicon substrate</p></td>
<td><p>s_si</p></td>
</tr>
<tr class="row-even"><td><p>SLD of the silicon substrate</p></td>
<td><p>r_si</p></td>
</tr>
<tr class="row-odd"><td><p>thickness of the silicon oxide layer</p></td>
<td><p>d_sio2</p></td>
</tr>
<tr class="row-even"><td><p>roughness of the silicon oxide layer</p></td>
<td><p>s_sio2</p></td>
</tr>
<tr class="row-odd"><td><p>SLD of the silicon oxide layer</p></td>
<td><p>r_sio2</p></td>
</tr>
<tr class="row-even"><td><p>SLD of the phase layer</p></td>
<td><p>r3</p></td>
</tr>
<tr class="row-odd"><td><p>relative thickness of the phase layer (wrt. the monolayer thickness)</p></td>
<td><p>d3_rel</p></td>
</tr>
<tr class="row-even"><td><p>relative roughness of the phase layer (wrt. the monolayer thickness)</p></td>
<td><p>s3_rel</p></td>
</tr>
<tr class="row-odd"><td><p>relative position of the first sigmoid (i.e. total film thickness)</p></td>
<td><p>d_full_rel</p></td>
</tr>
<tr class="row-even"><td><p>relative width of the first sigmoid</p></td>
<td><p>rel_sigmas</p></td>
</tr>
<tr class="row-odd"><td><p>relative position of the second sigmoid (coherently ordered film thickness)</p></td>
<td><p>dr_sigmoid_rel_pos</p></td>
</tr>
<tr class="row-even"><td><p>relative width of the second sigmoid</p></td>
<td><p>dr_sigmoid_rel_width</p></td>
</tr>
</tbody>
</table>
<p>We can initialize a reflectorch model which uses this type of SLD parameterization by making the following changes to the YAML configuration file:</p>
<ol class="arabic simple">
<li><p>Firstly, we set the <code class="docutils literal notranslate"><span class="pre">model_name</span></code> argument of the prior sampler to <code class="docutils literal notranslate"><span class="pre">repeating_multilayer_v3</span></code> instead of <code class="docutils literal notranslate"><span class="pre">standard_model</span></code>, and the <code class="docutils literal notranslate"><span class="pre">max_num_layers</span></code> argument to a high value representing the maximum considered number of monolayers (e.g. 30). In addition, the parameter ranges and bound width ranges for the 17 multilayer parameters must be specified (the above table shows the correspondance between the physical parameters and their YAML subkeys in the configuration file).</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dset</span><span class="p">:</span>
<span class="w">  </span><span class="nt">prior_sampler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SubpriorParametricSampler</span>
<span class="w">    </span><span class="nt">kwargs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">param_ranges</span><span class="p">:</span>
<span class="w">          </span><span class="nt">d_full_rel</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">25</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">rel_sigmas</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">dr_sigmoid_rel_pos</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-10</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">dr_sigmoid_rel_width</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">d_block1_rel</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.99</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">d_block</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">10</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">s_block_rel</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.3</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">r_block</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20.</span><span class="p p-Indicator">]</span><span class="w"> </span>
<span class="w">          </span><span class="nt">dr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-10.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10.</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">d3_rel</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">]</span><span class="w"> </span>
<span class="w">          </span><span class="nt">s3_rel</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">]</span><span class="w"> </span>
<span class="w">          </span><span class="nt">r3</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">25</span><span class="p p-Indicator">]</span><span class="w"> </span>
<span class="w">          </span><span class="nt">d_sio2</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">]</span><span class="w"> </span>
<span class="w">          </span><span class="nt">s_sio2</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">]</span><span class="w"> </span>
<span class="w">          </span><span class="nt">s_si</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">]</span><span class="w"> </span>
<span class="w">          </span><span class="nt">r_sio2</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">17.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">19.</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">r_si</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">19.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">21.</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">bound_width_ranges</span><span class="p">:</span>
<span class="w">          </span><span class="nt">d_full_rel</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">25</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">rel_sigmas</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">dr_sigmoid_rel_pos</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">dr_sigmoid_rel_width</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">d_block1_rel</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">d_block</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10.</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">s_block_rel</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.3</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">r_block</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">dr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">d3_rel</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">s3_rel</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">r3</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">25</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">d_sio2</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">s_sio2</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">s_si</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">r_sio2</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">r_si</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">]</span>
<span class="hll"><span class="w">      </span><span class="nt">model_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">repeating_multilayer_v3</span>
</span><span class="hll"><span class="w">      </span><span class="nt">max_num_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</span><span class="w">      </span><span class="nt">logdist</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">scale_params_by_ranges</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">scaled_range</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-1.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cuda&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>The neural network architecture must be set up such that the <code class="docutils literal notranslate"><span class="pre">dim_out</span></code> argument (i.e. the output dimension) is set to the number of predicted parameters which in this case is 17.</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">encoder</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkWithPriorsConvEmb</span>
<span class="w">    </span><span class="nt">pretrained_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">    </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cuda&#39;</span>
<span class="w">    </span><span class="nt">kwargs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">in_channels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">hidden_channels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">32</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">64</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">128</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">256</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">512</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">dim_embedding</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<span class="w">      </span><span class="nt">dim_avpool</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">embedding_net_activation</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;gelu&#39;</span>
<span class="w">      </span><span class="nt">use_batch_norm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="hll"><span class="w">      </span><span class="nt">dim_out</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">17</span>
</span><span class="w">      </span><span class="nt">layer_width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="w">      </span><span class="nt">num_blocks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span>
<span class="w">      </span><span class="nt">repeats_per_block</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">      </span><span class="nt">mlp_activation</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;gelu&#39;</span>
<span class="w">      </span><span class="nt">dropout_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span><span class="w"> </span>
<span class="w">      </span><span class="nt">pretrained_embedding_net</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</pre></div>
</div>
<!-- ```{figure} fig_reflectometry_embedding_networks.png
:scale: 25 %
:align: center
:name: embedding_networks
Embedding Networks
``` --><section id="trainer">
<h4><span class="section-number">4.1.2.1. </span>Trainer<a class="headerlink" href="#trainer" title="Link to this heading">#</a></h4>
<p>We initialize a model with absorption from a suitable configuration file. Here we use an extended q range, up to 0.5 Å<span class="math notranslate nohighlight">\(^{-1}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">get_trainer_by_name</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="s1">&#39;c_repeating_multilayer&#39;</span><span class="p">,</span> <span class="n">load_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model c_repeating_multilayer loaded. Number of parameters: 3.85 M
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulated_data</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

<span class="n">n_layers</span> <span class="o">=</span> <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max_layer_num</span>
<span class="n">n_params</span> <span class="o">=</span> <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_params</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Max number of layers: </span><span class="si">{</span><span class="n">n_layers</span><span class="si">}</span><span class="s1">,  Number of film parameters: </span><span class="si">{</span><span class="n">n_params</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Max number of layers: 30,  Number of film parameters: 17
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">to_np</span><span class="p">(</span><span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;q_values&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">scaled_noisy_curves</span> <span class="o">=</span> <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;scaled_noisy_curves&#39;</span><span class="p">]</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;q [$Å^{-1}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R$_</span><span class="si">{scaled}</span><span class="s1">$ (q)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">to_np</span><span class="p">(</span><span class="n">scaled_noisy_curves</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">2.0</span><span class="p">);</span>

<span class="n">z_axis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">sld_profile</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_density_profiles</span><span class="p">(</span>
    <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">thicknesses</span><span class="p">,</span> 
    <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">roughnesses</span><span class="p">,</span>
    <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slds</span><span class="p">,</span>
    <span class="n">z_axis</span><span class="p">)</span>
    
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z_axis</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">to_np</span><span class="p">(</span><span class="n">sld_profile</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ground truth&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;z [$Å$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;SLD [$10^{-6} Å^{-2}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/3032465085654ffdb6867123c628f2cf254e999fbed6a3e83f086fbefff32f60.png" src="_images/3032465085654ffdb6867123c628f2cf254e999fbed6a3e83f086fbefff32f60.png" />
</div>
</div>
</section>
<section id="inference">
<h4><span class="section-number">4.1.2.2. </span>Inference<a class="headerlink" href="#inference" title="Link to this heading">#</a></h4>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inference_model</span> <span class="o">=</span> <span class="n">EasyInferenceModel</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="s1">&#39;c_repeating_multilayer_trained1&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Configuration file `D:\Github Projects\reflectorch\reflectorch\configs\c_repeating_multilayer_trained1.yaml` found locally.
Weights file `D:\Github Projects\reflectorch\reflectorch\saved_models\model_c_repeating_multilayer_trained1.pt` found locally.
Model c_repeating_multilayer_trained1 loaded. Number of parameters: 3.85 M
The model corresponds to a `repeating_multilayer_v3` parameterization with 30 layers (17 predicted parameters)
Parameter types and total ranges:
- d_full_rel: [0, 25]
- rel_sigmas: [0, 5]
- dr_sigmoid_rel_pos: [-10, 10]
- dr_sigmoid_rel_width: [0, 20]
- d_block1_rel: [0.01, 0.99]
- d_block: [10, 20]
- s_block_rel: [0.0, 0.3]
- r_block: [0.0, 20.0]
- dr: [-10.0, 10.0]
- d3_rel: [0, 1]
- s3_rel: [0, 1]
- r3: [0.0, 25]
- d_sio2: [0, 10]
- s_sio2: [0, 10]
- s_si: [0.0, 10]
- r_sio2: [17.0, 19.0]
- r_si: [19.0, 21.0]
Allowed widths of the prior bound intervals (max-min):
- d_full_rel: [0.1, 25]
- rel_sigmas: [0.1, 5]
- dr_sigmoid_rel_pos: [0.1, 20]
- dr_sigmoid_rel_width: [0.1, 20]
- d_block1_rel: [0.01, 1.0]
- d_block: [0.1, 10.0]
- s_block_rel: [0.1, 0.3]
- r_block: [0.1, 5.0]
- dr: [0.1, 5.0]
- d3_rel: [0.01, 1]
- s3_rel: [0.01, 1]
- r3: [0.01, 25]
- d_sio2: [0.01, 10]
- s_sio2: [0.01, 10]
- s_si: [0.01, 10]
- r_sio2: [0.01, 2]
- r_si: [0.01, 2]
The model was trained on curves discretized at 256 uniform points between between q_min=0.02 and q_max=0.5
</pre></div>
</div>
</div>
</div>
<p>We load an experimental curve and make a prediction:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multilayer_data_path</span> <span class="o">=</span> <span class="s1">&#39;.././exp_data/DIP-nSi_34a.dat&#39;</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">multilayer_data_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

<span class="n">q_vals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">intensity_vals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
    <span class="n">q_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">intensity_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    
<span class="n">q_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q_vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">intensity_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">intensity_vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="n">interp_range</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
<span class="n">interp_points</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">q_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">interp_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interp_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">interp_points</span><span class="p">)</span>

<span class="n">min_q_idx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">q_vals</span> <span class="o">-</span> <span class="n">interp_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
<span class="n">max_q_idx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">q_vals</span> <span class="o">-</span> <span class="n">interp_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">q_vals</span><span class="p">[</span><span class="n">min_q_idx</span><span class="p">:</span><span class="n">max_q_idx</span><span class="p">]</span>
<span class="n">curve</span> <span class="o">=</span> <span class="n">intensity_vals</span><span class="p">[</span><span class="n">min_q_idx</span><span class="p">:</span><span class="n">max_q_idx</span><span class="p">]</span>
<span class="n">exp_curve_interp</span> <span class="o">=</span> <span class="n">interp_reflectivity</span><span class="p">(</span><span class="n">q_interp</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">curve</span><span class="p">)</span>

<span class="n">q_model</span> <span class="o">=</span> <span class="n">inference_model</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">q_generator</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">prior_bounds</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span> <span class="c1">#relative sigmoid center</span>
    <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">),</span> <span class="c1">#relative roughness</span>
    <span class="p">(</span><span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">),</span> <span class="c1">#position of the second sigmoid relative to d_full_rel (units are d_block)</span>
    <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span> <span class="c1">#width of the second sigmoid relative to d_full_rel (units are d_block)</span>
    <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="c1">#fractional thickness of one box1 in the monolayer</span>
    <span class="p">(</span><span class="mf">16.</span><span class="p">,</span> <span class="mf">17.5</span><span class="p">),</span> <span class="c1">#thickness of one monolayer (two boxes stacked together)</span>
    <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span> <span class="c1">#roughness of each interface in the monolayer relative to d_block</span>
    <span class="p">(</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span> <span class="c1">##SLD of box1 in the multilayer</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">),</span> <span class="c1">#dr = SLD(box2) - SLD(box1)</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1">#relative thickness of phase layer with respect to d_block</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1">#relative roughness of phase layer with respect to d_block</span>
    <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="c1">#SLD of phase layer</span>
    <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="c1">#thickness SiO2</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="c1">#roughness SiO2</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="c1">#roughness Si</span>
    <span class="p">(</span><span class="mf">17.</span><span class="p">,</span> <span class="mf">18.</span><span class="p">),</span> <span class="c1">#SLD SiO2</span>
    <span class="p">(</span><span class="mf">19.5</span><span class="p">,</span> <span class="mf">20.5</span><span class="p">),</span> <span class="c1">#SLD Si</span>
<span class="p">]</span>

<span class="n">prediction_dict</span> <span class="o">=</span> <span class="n">inference_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">reflectivity_curve</span><span class="o">=</span><span class="n">exp_curve_interp</span><span class="p">,</span>
                                          <span class="n">q_values</span><span class="o">=</span><span class="n">q_model</span><span class="p">,</span>
                                          <span class="n">prior_bounds</span><span class="o">=</span><span class="n">prior_bounds</span><span class="p">,</span>
                                          <span class="n">clip_prediction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">calc_pred_curve</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">calc_pred_sld_profile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="p">)</span>


<span class="n">pred_params</span> <span class="o">=</span> <span class="n">prediction_dict</span><span class="p">[</span><span class="s1">&#39;predicted_params_array&#39;</span><span class="p">]</span>
<span class="n">pred_curve</span> <span class="o">=</span> <span class="n">prediction_dict</span><span class="p">[</span><span class="s1">&#39;predicted_curve&#39;</span><span class="p">]</span>

<span class="n">pred_sld_xaxis</span> <span class="o">=</span> <span class="n">prediction_dict</span><span class="p">[</span><span class="s1">&#39;predicted_sld_xaxis&#39;</span><span class="p">]</span>
<span class="n">pred_sld_profile</span> <span class="o">=</span> <span class="n">prediction_dict</span><span class="p">[</span><span class="s1">&#39;predicted_sld_profile&#39;</span><span class="p">]</span>

<span class="n">n_layers</span> <span class="o">=</span> <span class="n">inference_model</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">prior_sampler</span><span class="o">.</span><span class="n">max_num_layers</span>
<span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prediction_dict</span><span class="p">[</span><span class="s2">&quot;param_names&quot;</span><span class="p">],</span> <span class="n">pred_params</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">param_name</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">param_val</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.5e-10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;q [$Å^{-1}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R(q)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">y_tick_locations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">y_tick_locations</span><span class="p">))</span>
    
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q_model</span><span class="p">,</span> <span class="n">exp_curve_interp</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;interp exp. curve&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">q_model</span><span class="p">,</span> <span class="n">pred_curve</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred. curve&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">);</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pred_sld_xaxis</span><span class="p">,</span> <span class="n">pred_sld_profile</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;z [$Å$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;SLD [$10^{-6} Å^{-2}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>d_full_rel           : 12.20
rel_sigmas           : 1.75
dr_sigmoid_rel_pos   : -2.30
dr_sigmoid_rel_width : 16.05
d_block1_rel         : 0.74
d_block              : 16.80
s_block_rel          : 0.06
r_block              : 14.76
dr                   : -8.56
d3_rel               : 0.18
s3_rel               : 0.41
r3                   : 9.58
d_sio2               : 7.33
s_sio2               : 1.83
s_si                 : 4.83
r_sio2               : 17.52
r_si                 : 20.19
</pre></div>
</div>
<img alt="_images/d06c461edbc6816f6bfffbb91ede2b62e2e5bce5bd1b258a1f77c64beb4203be.png" src="_images/d06c461edbc6816f6bfffbb91ede2b62e2e5bce5bd1b258a1f77c64beb4203be.png" />
</div>
</div>
</section>
</section>
<section id="model-with-shifts">
<h3><span class="section-number">4.1.3. </span>Model with shifts<a class="headerlink" href="#model-with-shifts" title="Link to this heading">#</a></h3>
<p>This is a version of the standard box model parameterization, but the horizontal and vertical shifts of the reflectivity curve are additional predicted parameters.</p>
<ol class="arabic simple">
<li><p>Firstly, we set the <code class="docutils literal notranslate"><span class="pre">model_name</span></code> argument of the prior sampler to <code class="docutils literal notranslate"><span class="pre">model_with_shifts</span></code> instead of <code class="docutils literal notranslate"><span class="pre">standard_model</span></code>. In addition, the parameter range and bound width range of the q shifts (<code class="docutils literal notranslate"><span class="pre">q_shift</span></code>) and (multiplicative) normalization shifts (<code class="docutils literal notranslate"><span class="pre">norm_shift</span></code>) must be specified.</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dset</span><span class="p">:</span>
<span class="w">  </span><span class="nt">prior_sampler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SubpriorParametricSampler</span>
<span class="w">    </span><span class="nt">kwargs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">param_ranges</span><span class="p">:</span>
<span class="w">        </span><span class="nt">thicknesses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">500.</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">roughnesses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20.</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">slds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">25.</span><span class="p p-Indicator">]</span>
<span class="hll"><span class="w">        </span><span class="nt">q_shift</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-0.002</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.002</span><span class="p p-Indicator">]</span>
</span><span class="hll"><span class="w">        </span><span class="nt">norm_shift</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.2</span><span class="p p-Indicator">]</span>
</span><span class="w">      </span><span class="nt">bound_width_ranges</span><span class="p">:</span>
<span class="w">        </span><span class="nt">thicknesses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1.0e-2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">500.</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">roughnesses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1.0e-2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20.</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">slds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">1.0e-2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4.</span><span class="p p-Indicator">]</span>
<span class="hll"><span class="w">        </span><span class="nt">q_shift</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1.0e-3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.004</span><span class="p p-Indicator">]</span>
</span><span class="hll"><span class="w">        </span><span class="nt">norm_shift</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1.0e-2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.4</span><span class="p p-Indicator">]</span>
</span><span class="hll"><span class="w">      </span><span class="nt">model_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model_with_shifts</span>
</span><span class="w">      </span><span class="nt">max_num_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">      </span><span class="nt">constrained_roughness</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">max_thickness_share</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
<span class="w">      </span><span class="nt">logdist</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">scale_params_by_ranges</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">scaled_range</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-1.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cuda&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>The output dimension of the neural network must also be modified to to account for the two additional parameters.</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">network</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkWithPriorsConvEmb</span>
<span class="w">    </span><span class="nt">pretrained_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">    </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cuda&#39;</span>
<span class="w">    </span><span class="nt">kwargs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">in_channels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">hidden_channels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">32</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">64</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">128</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">256</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">512</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">dim_embedding</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<span class="w">      </span><span class="nt">dim_avpool</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">embedding_net_activation</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;gelu&#39;</span>
<span class="w">      </span><span class="nt">use_batch_norm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="hll"><span class="w">      </span><span class="nt">dim_out</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span class="w">      </span><span class="nt">layer_width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="w">      </span><span class="nt">num_blocks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span>
<span class="w">      </span><span class="nt">repeats_per_block</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">      </span><span class="nt">mlp_activation</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;gelu&#39;</span>
<span class="w">      </span><span class="nt">dropout_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span><span class="w"> </span>
<span class="w">      </span><span class="nt">pretrained_embedding_net</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</pre></div>
</div>
<p>We initialize a model with shifts from a suitable configuration file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">get_trainer_by_name</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="s1">&#39;c_model_with_shifts&#39;</span><span class="p">,</span> <span class="n">load_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">prior_sampler</span><span class="o">.</span><span class="n">param_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model c_model_with_shifts loaded. Number of parameters: 3.84 M
&lt;reflectorch.data_generation.priors.parametric_models.ModelWithShifts object at 0x000001B1F06FABB0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">simulated_data</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">get_batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>

<span class="n">n_layers</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">max_layer_num</span>
<span class="n">n_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">num_params</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of layers: </span><span class="si">{</span><span class="n">n_layers</span><span class="si">}</span><span class="s1">,  Number of film parameters: </span><span class="si">{</span><span class="n">n_params</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of layers: 2,  Number of film parameters: 10
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;q_values&#39;</span><span class="p">]</span>
<span class="n">scaled_noisy_curves</span> <span class="o">=</span> <span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;scaled_noisy_curves&#39;</span><span class="p">]</span>
<span class="n">curves_without_shifts</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">curves_scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span>
    <span class="n">reflectivity</span><span class="p">(</span><span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;q_values&#39;</span><span class="p">],</span> <span class="n">params</span><span class="o">.</span><span class="n">thicknesses</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">roughnesses</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">slds</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Q shift: </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s1">  Intensity shift: </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">to_np</span><span class="p">(</span><span class="n">simulated_data</span><span class="p">[</span><span class="s1">&#39;q_values&#39;</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;q [$Å^{-1}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R$_</span><span class="si">{scaled}</span><span class="s1">$ (q)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">to_np</span><span class="p">(</span><span class="n">scaled_noisy_curves</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;shifted curve&#39;</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">to_np</span><span class="p">(</span><span class="n">curves_without_shifts</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;original curve&#39;</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Q shift: -0.0011754242598062277  Intensity shift: 0.9204985043289542
</pre></div>
</div>
<img alt="_images/a8216c88102285c58af52732aad1a43ad5d47aa8b2d194ec59cf6475ab1575b9.png" src="_images/a8216c88102285c58af52732aad1a43ad5d47aa8b2d194ec59cf6475ab1575b9.png" />
</div>
</div>
</section>
</section>
<section id="using-alternative-embedding-networks">
<h2><span class="section-number">4.2. </span>Using alternative embedding networks<a class="headerlink" href="#using-alternative-embedding-networks" title="Link to this heading">#</a></h2>
<p>Embedding networks have the role of processing the reflectivity curves, producing a latent representation which is fed together with the prior bounds to the main fully-connected (MLP) network in order to obtain the predictions. The default embedding network is the 1D CNN which works on reflectivity curves with fixed discretization (fixed q range and number of points in the curves). The arguments of the 1D CNN embedding network have been already explained in the previous section.</p>
<figure class="align-center" id="figure-embedding-networks">
<a class="reference internal image-reference" href="_images/fig_reflectometry_embedding_networks.png"><img alt="_images/fig_reflectometry_embedding_networks.png" src="_images/fig_reflectometry_embedding_networks.png" style="width: 453.0px; height: 459.75px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 4.2 </span><span class="caption-text">Embedding networks: (a) CNN (b) FNO</span><a class="headerlink" href="#figure-embedding-networks" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Alternatively, we can use an embedding network inspired by the Fourier Neural Operator (FNO) architecture. In this scenario the reflectivity curves together with their respective q-values are input to the embedding network. It allows us to train the model on reflectivity curves with variable discretizations (variable q ranges and numbers of points in the curves).</p>
<p>We can initialize a reflectorch model which uses the FNO-based embedding network by making the following changes to the YAML configuration file:</p>
<ol class="arabic simple">
<li><p>Firstly, the <code class="docutils literal notranslate"><span class="pre">q_generator</span></code> has to be changed to <code class="docutils literal notranslate"><span class="pre">VariableQ</span></code> instead of <code class="docutils literal notranslate"><span class="pre">ConstantQ</span></code>. Its arguments are:</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">q_min_range</span></code> - the range for sampling the minimum q value of the curves, <em>q_min</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">q_max_range</span></code> - the range for sampling the maximum q value of the curves, <em>q_max</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_q_range</span></code> - the range for the number of points in the curves (equidistantly sampled between <em>q_min</em> and <em>q_max</em>, the number of points varies between batches but is constant within a batch)</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dset</span><span class="p">:</span><span class="w">     </span>
<span class="w">  </span><span class="nt">q_generator</span><span class="p">:</span>
<span class="hll"><span class="w">    </span><span class="nt">cls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VariableQ</span>
</span><span class="w">    </span><span class="nt">kwargs</span><span class="p">:</span>
<span class="hll"><span class="w">      </span><span class="nt">q_min_range</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.03</span><span class="p p-Indicator">]</span>
</span><span class="hll"><span class="w">      </span><span class="nt">q_max_range</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.15</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.4</span><span class="p p-Indicator">]</span>
</span><span class="hll"><span class="w">      </span><span class="nt">n_q_range</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">128</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">256</span><span class="p p-Indicator">]</span>
</span><span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cuda&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>The network architecture is changed to be an instance of the <code class="docutils literal notranslate"><span class="pre">NetworkWithPriorsFnoEmb</span></code> class, which has the following keyword arguments:</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">in_channels</span></code> - the number of input channels to the FNO-based embedding network  (should be 2, i.e. (R(q), q))</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dim_embedding</span></code> - the dimension of the embedding produced by the FNO</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">width_fno</span></code> - the number of channels in the FNO blocks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_fno_blocks</span></code>- the number of FNO blocks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modes</span></code> - the number of Fourier modes that are utilized</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embedding_net_activation</span></code> - the type of activation function in the embedding network</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fusion_self_attention</span></code> - if <code class="docutils literal notranslate"><span class="pre">True</span></code> a fusion layer is used after the FNO blocks to produce the final output</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">use_batch_norm</span></code> - whether to use batch normalization (only in the MLP)</p></li>
</ul>
<p>The other keyword arguments are the same as for the <code class="docutils literal notranslate"><span class="pre">NetworkWithPriorsConvEmb</span></code> class.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">network</span><span class="p">:</span>
<span class="hll"><span class="w">    </span><span class="nt">cls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkWithPriorsFnoEmb</span>
</span><span class="w">    </span><span class="nt">pretrained_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">    </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cuda&#39;</span>
<span class="w">    </span><span class="nt">kwargs</span><span class="p">:</span>
<span class="hll"><span class="w">      </span><span class="nt">in_channels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span class="w">      </span><span class="nt">dim_embedding</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256</span>
<span class="hll"><span class="w">      </span><span class="nt">width_fno</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
</span><span class="hll"><span class="w">      </span><span class="nt">n_fno_blocks </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span>
</span><span class="hll"><span class="w">      </span><span class="nt">modes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">16</span>
</span><span class="w">      </span><span class="nt">embedding_net_activation</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;gelu&#39;</span>
<span class="w">      </span><span class="nt">use_batch_norm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="w">      </span><span class="nt">dim_out</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">      </span><span class="nt">layer_width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="w">      </span><span class="nt">num_blocks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">      </span><span class="nt">repeats_per_block</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">      </span><span class="nt">mlp_activation</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;gelu&#39;</span>
<span class="w">      </span><span class="nt">dropout_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span><span class="w"> </span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>The <code class="docutils literal notranslate"><span class="pre">train_with_q_input</span></code> subkey of the <code class="docutils literal notranslate"><span class="pre">training</span></code> key must be set to <code class="docutils literal notranslate"><span class="pre">True</span></code>. Enabling gradient clipping (<code class="docutils literal notranslate"><span class="pre">clip_grad_norm_max</span></code>) is also recommended.</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">training</span><span class="p">:</span>
<span class="w">  </span><span class="nt">num_iterations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">  </span><span class="nt">batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1024</span>
<span class="w">  </span><span class="nt">lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0e-4</span>
<span class="w">  </span><span class="nt">grad_accumulation_steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="hll"><span class="w">  </span><span class="nt">clip_grad_norm_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</span><span class="hll"><span class="w">  </span><span class="nt">train_with_q_input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</span></pre></div>
</div>
<p>We initialize a model having a FNO-based embedding network from a suitable configuration file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">get_trainer_by_name</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="s1">&#39;c_fno&#39;</span><span class="p">,</span> <span class="n">load_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model c_fno loaded. Number of parameters: 4.52 M
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NetworkWithPriorsFnoEmb(
  (embedding_net): FnoEncoder(
    (activation): GELU(approximate=&#39;none&#39;)
    (fc0): Linear(in_features=2, out_features=128, bias=True)
    (spectral_convs): ModuleList(
      (0-5): 6 x SpectralConv1d()
    )
    (w_convs): ModuleList(
      (0-5): 6 x Conv1d(128, 128, kernel_size=(1,), stride=(1,))
    )
    (fc_out): Linear(in_features=128, out_features=256, bias=True)
    (fusion): FusionSelfAttention(
      (fuser): Sequential(
        (0): Linear(in_features=128, out_features=256, bias=True)
        (1): Tanh()
        (2): Linear(in_features=256, out_features=1, bias=False)
      )
    )
  )
  (mlp): ResidualMLP(
    (first_layer): Linear(in_features=272, out_features=512, bias=True)
    (blocks): ModuleList(
      (0-4): 5 x ResidualBlock(
        (activation): GELU(approximate=&#39;none&#39;)
        (batch_norm_layers): ModuleList(
          (0-1): 2 x BatchNorm1d(512, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
        )
        (linear_layers): ModuleList(
          (0-1): 2 x Linear(in_features=512, out_features=512, bias=True)
        )
      )
    )
    (last_layer): Linear(in_features=512, out_features=8, bias=True)
  )
)
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-alternative-trainers">
<h2><span class="section-number">4.3. </span>Using alternative trainers<a class="headerlink" href="#using-alternative-trainers" title="Link to this heading">#</a></h2>
<p>By default the class of the trainer object is <code class="docutils literal notranslate"><span class="pre">PointEstimatorTrainer</span></code>, whose purpose is to train the neural network as a regression problem for predicting the physical parameters based on the reflectivity curves and the prior bounds for the parameters. Other types of trainers can also be specified, for example a trainer used for encoding reflectivity curves to latent representation.</p>
<p>In the configuration file, the <code class="docutils literal notranslate"><span class="pre">trainer_cls</span></code> subkey of the <code class="docutils literal notranslate"><span class="pre">training</span></code> key is set to <code class="docutils literal notranslate"><span class="pre">DenoisingAETrainer</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">training</span><span class="p">:</span>
<span class="hll"><span class="w">  </span><span class="nt">trainer_cls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DenoisingAETrainer</span>
</span></pre></div>
</div>
<p>We also select an appropriate neural network for this task:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">network</span><span class="p">:</span>
<span class="hll"><span class="w">    </span><span class="nt">cls</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConvAutoencoder</span>
</span><span class="w">    </span><span class="nt">pretrained_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">    </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cuda&#39;</span>
<span class="w">    </span><span class="nt">kwargs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">in_channels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">encoder_hidden_channels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">32</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">64</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">128</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">256</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">512</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">decoder_hidden_channels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">512</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">256</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">128</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">64</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">32</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">dim_latent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<span class="w">      </span><span class="nt">dim_avpool</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">use_batch_norm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">activation</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;gelu&#39;</span>
<span class="w">      </span><span class="nt">decoder_in_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w"> </span><span class="c1"># num_q_points / 32</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">get_trainer_by_name</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="s1">&#39;c_ae&#39;</span><span class="p">,</span> <span class="n">load_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model c_ae loaded. Number of parameters: 1.22 M
&lt;reflectorch.ml.trainers.DenoisingAETrainer object at 0x000001B1F0735F40&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ConvAutoencoder(
  (encoder): ConvEncoder(
    (core): Sequential(
      (0): Sequential(
        (0): Conv1d(1, 32, kernel_size=(3,), stride=(2,), padding=(1,))
        (1): BatchNorm1d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): GELU(approximate=&#39;none&#39;)
      )
      (1): Sequential(
        (0): Conv1d(32, 64, kernel_size=(3,), stride=(2,), padding=(1,))
        (1): BatchNorm1d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): GELU(approximate=&#39;none&#39;)
      )
      (2): Sequential(
        (0): Conv1d(64, 128, kernel_size=(3,), stride=(2,), padding=(1,))
        (1): BatchNorm1d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): GELU(approximate=&#39;none&#39;)
      )
      (3): Sequential(
        (0): Conv1d(128, 256, kernel_size=(3,), stride=(2,), padding=(1,))
        (1): BatchNorm1d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): GELU(approximate=&#39;none&#39;)
      )
      (4): Sequential(
        (0): Conv1d(256, 512, kernel_size=(3,), stride=(2,), padding=(1,))
        (1): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): GELU(approximate=&#39;none&#39;)
      )
    )
    (avpool): AdaptiveAvgPool1d(output_size=1)
    (fc): Linear(in_features=512, out_features=64, bias=True)
  )
  (decoder): ConvDecoder(
    (decoder_input): Linear(in_features=64, out_features=2048, bias=True)
    (decoder): Sequential(
      (0): Sequential(
        (0): ConvTranspose1d(512, 256, kernel_size=(3,), stride=(2,), padding=(1,), output_padding=(1,))
        (1): BatchNorm1d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): GELU(approximate=&#39;none&#39;)
      )
      (1): Sequential(
        (0): ConvTranspose1d(256, 128, kernel_size=(3,), stride=(2,), padding=(1,), output_padding=(1,))
        (1): BatchNorm1d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): GELU(approximate=&#39;none&#39;)
      )
      (2): Sequential(
        (0): ConvTranspose1d(128, 64, kernel_size=(3,), stride=(2,), padding=(1,), output_padding=(1,))
        (1): BatchNorm1d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): GELU(approximate=&#39;none&#39;)
      )
      (3): Sequential(
        (0): ConvTranspose1d(64, 32, kernel_size=(3,), stride=(2,), padding=(1,), output_padding=(1,))
        (1): BatchNorm1d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): GELU(approximate=&#39;none&#39;)
      )
    )
    (final_layer): Sequential(
      (0): ConvTranspose1d(32, 32, kernel_size=(3,), stride=(2,), padding=(1,), output_padding=(1,))
      (1): BatchNorm1d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (2): GELU(approximate=&#39;none&#39;)
      (3): Conv1d(32, 1, kernel_size=(3,), stride=(1,), padding=(1,))
    )
  )
)
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "schreiber-lab/reflectorch",
            ref: "dev_vm",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="training_reflectorch.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">3. </span>Training a reflectorch model</p>
      </div>
    </a>
    <a class="right-next"
       href="api.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">5. </span>API Reference</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-alternative-parameterizations-of-the-sld-profile">4.1. Using alternative parameterizations of the SLD profile</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-with-absorption">4.1.1. Model with absorption</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#periodically-repeating-monolayer">4.1.2. Periodically repeating monolayer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#trainer">4.1.2.1. Trainer</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inference">4.1.2.2. Inference</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-with-shifts">4.1.3. Model with shifts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-alternative-embedding-networks">4.2. Using alternative embedding networks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-alternative-trainers">4.3. Using alternative trainers</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Schreiber Lab
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>